name: Publish to FoundryVTT
on: 
  workflow_dispatch:
    inputs: 
      tag: 
        description: "The release tag to create"
        default: "latest"
        required: true
        type: string
jobs: 
  publish:
    permissions: write-all
    name: Publish to FoundryVTT
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install Dependencies
        run: |
          npm ci
      - name: Package SRD Content
        run: |
          npm run pack --if-present
      - name: Compress
        run: |
          cd ../
          rm -rf table-safety.zip
          rm -rf table-safety.zip
          zip -r utopia.zip table-safety -x ".git/*" ".github/*"
      - name: Add Build to Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ inputs.tag }}
          tag_name: ${{ inputs.tag}}
          files: |
            ../table-safety.zip
            ../table-safety/system.json
          generate_release_notes: true
          draft: false
      - name: Deploy
        uses: fjogeleit/http-request-action@v1
        with:
          url: "https://api.foundryvtt.com/_api/packages/release_version/"
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json", "Authorization": "${{ secrets.FoundryVTT_API_Key }}"}'
          data: '{ "id": "table-safety", "dry-run": false, "release": { "version": "${{ inputs.tag }}", "manifest": "https://github.com/VoltaicGRiD/table-safety/releases/download/${{ inputs.tag }}/system.json", "notes": "https://github.com/VoltaicGRiD/table-safety/releases/tag/${{ inputs.tag }}", "compatibility": { "minimum": "12", "verified": "12.133", "maximum": "12" } } }'
